{% extends 'layout.twig' %}
{% block content %}
  <div class="flex items-center justify-between"><h1 class="text-2xl font-bold">Tickets</h1><a href="/tickets/new" class="px-3 py-2 rounded bg-blue-600 text-white">New Ticket</a></div>
  <div class="mt-6 grid md:grid-cols-3 gap-4">
    <div class="md:col-span-2">
      <div id="tickets-list">Loading...</div>
    </div>
    <aside>
      <h2 class="text-lg font-semibold">Create Ticket</h2>
      <div class="mt-4">
        <form id="create-form" class="bg-white p-4 rounded-lg shadow">
          <label class="block mb-2">Title
            <input id="new-title" class="mt-1 block w-full rounded border px-3 py-2" />
          </label>
          <div id="new-title-error" class="text-red-600 text-sm" style="display:none"></div>
          <label class="block mt-4 mb-2">Description
            <textarea id="new-desc" class="mt-1 block w-full rounded border px-3 py-2"></textarea>
          </label>
          <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
            <label> Status
              <select id="new-status" class="mt-1 block w-full rounded border px-3 py-2"><option value="open">open</option><option value="in_progress">in_progress</option><option value="closed">closed</option></select>
            </label>
            <label> Priority
              <select id="new-priority" class="mt-1 block w-full rounded border px-3 py-2"><option value="low">low</option><option value="medium">medium</option><option value="high">high</option></select>
            </label>
          </div>
          <div class="mt-6"><button id="create-btn" type="button" class="px-4 py-2 rounded bg-blue-600 text-white">Save</button></div>
        </form>
      </div>
    </aside>
  </div>

  <script type="module">
    import { getSession, listTickets, createTicket, deleteTicket } from '/js/app.js'
    (async function(){
      const s = getSession(); if (!s) return window.location.href = '/auth/login'
      const listRoot = document.getElementById('tickets-list')
      async function load(){ listRoot.innerHTML = 'Loading...'; try{ const tickets = await listTickets(); if (tickets.length===0) { listRoot.innerHTML = '<div class="text-gray-600">No tickets yet.</div>'; return } listRoot.innerHTML = tickets.map(t=>`<div class="bg-white rounded-lg shadow p-4"><div class="flex items-start justify-between gap-3"><div><h3 class="font-semibold">${t.title}</h3><p class="text-sm text-gray-600 mt-2">${t.description||'â€”'}</p></div><div class="flex flex-col items-end gap-2"><span class="${t.status==='open'?'status-open': t.status==='in_progress'?'status-in_progress':'status-closed'} px-2 py-1 rounded-full text-xs">${t.status}</span><div class="flex gap-2 mt-2"><a href="/tickets/${t.id}" class="text-sm underline">View</a><a href="/tickets/${t.id}/edit" class="text-sm underline">Edit</a><button data-id="${t.id}" class="text-sm text-red-600 btn-del">Delete</button></div></div></div></div>`).join('') ; document.querySelectorAll('.btn-del').forEach(btn=> btn.addEventListener('click', async (e)=>{ if (!confirm('Delete this ticket?')) return; try{ await deleteTicket(btn.dataset.id); load() }catch(err){ alert('Failed to delete ticket') } })) }catch(e){ listRoot.innerHTML = '<div class="text-red-600">Failed to load tickets. Please retry.</div>' } }
      load()
      document.getElementById('create-btn').addEventListener('click', async ()=>{
        const title = document.getElementById('new-title').value.trim(); const desc = document.getElementById('new-desc').value.trim(); const status = document.getElementById('new-status').value; const priority = document.getElementById('new-priority').value; const titleErr = document.getElementById('new-title-error'); titleErr.style.display='none'; if (!title){ titleErr.textContent='Title is required.'; titleErr.style.display='block'; return }
        try{ await createTicket({ title, description: desc, status, priority }); load(); document.getElementById('new-title').value=''; document.getElementById('new-desc').value=''; alert('Ticket created') }catch(e){ alert('Failed to create ticket') }
      })
    })()
  </script>
{% endblock %}
